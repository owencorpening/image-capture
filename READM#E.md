# üì∏ Image Attribution Logger & Compliance Tool

The Image Attribution Logger is a seamless, zero-friction tool that automates image compliance for content creation. With a single click of a browser bookmarklet, it captures essential image metadata and instantly logs a formatted attribution string into a central Google Sheet, ensuring compliance is logged **at the point of capture**.

---

## üìñ Operational Overview

The tool is a two-part system that uses a highly reliable cross-origin data transfer method: a simple **GET** request with **URL parameters** and the `mode: 'no-cors'` setting to bypass restrictive Content Security Policy (CSP) blocks on source websites (like Unsplash).

### 1. Key Components

| Component | Function | Notes |
| :--- | :--- | :--- |
| **Google Sheet** | Central database for logging attribution and tracking post titles. | **Sheet Name:** `Sheet1` (Must match the tab name exactly) |
| **Apps Script** | Web App endpoint that receives the request and writes data to the Sheet. | Logic runs in the **`doGet(e)`** function. |
| **Bookmarklet** | Client-side JS to scrape data, format it, and initiate the request. | Optimized for major image sources (Unsplash, Pexels, Pixabay). |

### 2. Google Sheet Column Layout (7 Columns)

This is the required column order in your Google Sheet (starting from Column A).

| Col | Header Name | Data Source | Notes |
| :--- | :--- | :--- | :--- |
| **A** | Timestamp | `new Date()` | Automatically generated by the script. |
| **B** | Name | Page Title (CamelCase) | Generated using `toCamelCase()` from the page title. |
| **C** | Source URL | `document.location.href` | Direct URL of the image source page. |
| **D** | Photographer | Scraped / Fallback | Attempts to find photographer (e.g., Unsplash `/@[user]`), defaults to **'UNKNOWN'**. |
| **E** | License | Logic-based | **'CC0 Equivalent (No Attribution)'** for known free sites; otherwise **'MANUAL CHECK REQUIRED'**. |
| **F** | Substack Post Title | `''` | **Left blank** for manual entry later. |
| **G** | **Attribution String** | Constructed | The final formatted string ready for publication. |

---

## üíª Apps Script Source Code (`Code.gs`)

This code runs as the deployed Web App, listening for `GET` requests and appending rows to the sheet. **This block should be saved as your `Code.gs` file in the Apps Script Editor.**

```javascript
const SHEET_ID = '15Fl84stiKIyv9jGOxE5kMC5pJOXDDtyrm8TJoIlD6yc'; 
const SHEET_NAME = 'Sheet1'; // ***CRITICAL: MUST MATCH THE TAB NAME***

// --- API KEYS ---
const UNSPLASH_ACCESS_KEY = '5ZN-dlB6LNrZef1qIwlFkzWoQjoGFdjt19mfuZyTBMA'; // <-- Replace with your actual Unsplash Key
const PEXELS_ACCESS_KEY = 'WnRQ8bb6iPRim8pkNMzYxBAWGuAIkWcaVOcJAyJxJ8qAHZKvGSpZ7OAx'; 
// -----------------

/**
 * Helper to convert camelCase to Human Readable Title Case.
 */
function toTitleCase(camel) {
  return camel
    .replace(/([A-Z])/g, ' $1')
    .trim()
    .replace(/^./, str => str.toUpperCase());
}

/**
 * Fetches the author name from the Pexels API.
 */
function fetchPexelsAuthor(imageID) {
  const apiUrl = `https://api.pexels.com/v1/photos/${imageID}`;
  const options = {
    headers: {
      'Authorization': PEXELS_ACCESS_KEY
    }
  };
  
  try {
    const response = UrlFetchApp.fetch(apiUrl, options);
    const data = JSON.parse(response.getContentText());
    
    if (data.photographer) {
      return data.photographer;
    }
  } catch (e) {
    Logger.log("Pexels API fetch failed: " + e.toString());
  }
  return "UNKNOWN";
}

/**
 * Fetches the author name from the Unsplash API.
 */
function fetchUnsplashAuthor(imageID) {
  const apiUrl = `https://api.unsplash.com/photos/${imageID}?client_id=${UNSPLASH_ACCESS_KEY}`;
  
  try {
    const response = UrlFetchApp.fetch(apiUrl);
    const data = JSON.parse(response.getContentText());
    
    if (data.user && data.user.name) {
      return data.user.name;
    }
  } catch (e) {
    Logger.log("Unsplash API fetch failed: " + e.toString());
  }
  return "UNKNOWN";
}

/**
 * Handles incoming GET requests from the custom bookmarklet.
 */
function doGet(e) {
  const data = e.parameter;
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  // 1. Define the variables and attempt server-side author lookup
  const name = data.name;
  let photographer = "UNKNOWN"; // Start with UNKNOWN, then try APIs
  const license = data.license;
  const url = data.url; 
  
  // 1a. SERVER-SIDE ENHANCEMENT: API Lookup
  if (url.includes('unsplash.com/photos/')) {
    const urlParts = url.split('/');
    const imageID = urlParts[urlParts.length - 1].split('?')[0];
    photographer = fetchUnsplashAuthor(imageID);
  // ...inside doGet(e)
  } else if (url.includes('pexels.com/photo/')) {
    // NEW ROBUST PEXELS ID EXTRACTION: Use the last path segment (which is the ID)
    const urlParts = url.split('/');
    // Get the last segment (e.g., 1234567) and remove any query strings
    const imageID = urlParts[urlParts.length - 1].split('?')[0]; 
    
    // Check if the ID is found and call the API
    if (imageID) {
      photographer = fetchPexelsAuthor(imageID);
    }
  } 

// ... rest of the doGet(e) function

  // 2. CONSTRUCT THE ATTRIBUTION STRING
  const cleanName = toTitleCase(name);
  const urlDomainMatch = url.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n]+)/im);
  const sourceDomain = urlDomainMatch ? urlDomainMatch[1] : url;
  
  const attributionString = `Image: ${cleanName}, by ${photographer}, Source: ${sourceDomain}. License: ${license}.`;
  
  // 3. Define the final row data for columns A through G
  const rowData = [
    new Date(),               // A: Timestamp
    name,                     // B: Name (camelCase)
    url,                      // C: Source URL
    photographer,             // D: Photographer (from API or UNKNOWN)
    license,                  // E: License Status
    '',                       // F: Substack Post Title (left blank)
    attributionString         // G: Attribution String
  ];
  
  sheet.appendRow(rowData);
  
  return ContentService.createTextOutput("Success");
}
```

## üöÄ Final Bookmarklet String (Minified & Ready-to-Use)

This is the single line of code you **paste directly into your browser's bookmark manager**:

```javascript
javascript:void((function(){function toCamelCase(str){str=str.replace(/[^a-zA-Z0-9 ]/g,'').trim();return str.split(/\s+/).map((w,i)=>i==0?w.toLowerCase():w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join('');}var pageTitle=document.title||'newImage';var suggestedName=toCamelCase(pageTitle);var pageURL=document.location.href;var photographer='';var authorElement=document.querySelector('a[rel="author"],a[itemprop="author"] span,[data-testid*="photographer"],a[href^="/@"]');if(authorElement){photographer=authorElement.innerText.trim();}if(!photographer){var photoBy=document.querySelector('[class*="photographer"],[class*="author"]');if(photoBy&&photoBy.innerText.includes('by')){photographer=photoBy.innerText.replace(/.*by\\s/i,'').trim();}}if(!photographer){photographer='UNKNOWN';}var imageLicense='MANUAL CHECK REQUIRED';if(pageURL.includes('pexels.com')||pageURL.includes('pixabay.com')||pageURL.includes('unsplash.com')){imageLicense='CC0 Equivalent (No Attribution)';}var dataToSend={name:suggestedName,url:pageURL,photographer:photographer,license:imageLicense};var webAppURL='https://script.google.com/macros/s/AKfycbwuPPkOZMscb-9eRuKR2hEAShTqtVVC2gWcv783cawEqu0UpoMFOO4XDUwqcFwyrURdmQ/exec';var params=new URLSearchParams(dataToSend).toString();var finalURL=webAppURL+'?'+params;fetch(finalURL,{method:'GET',mode:'no-cors'}).then(response=>{alert("‚úÖ Data Sent to Compliance Ledger!\n\nName: "+suggestedName+"\nPhotographer: "+photographer+"\nSource: "+pageURL);}).catch(error=>{alert("‚ùå Error sending data to Google Sheet. Check console.");console.error('Fetch error:',error);});})());
```